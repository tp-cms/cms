{extend name="layout/main" /}

{block name="content"}
<div class="wrap-con">
    <div class="con-header">
        <h2>新增产品</h2>
    </div>
    <form class="layui-form" id="product-form">
        <!-- 名称 -->
        <div class="layui-form-item">
            <label class="layui-form-label">名称</label>
            <div class="layui-input-block">
                <input type="text" id="title" name="title" required lay-verify="required" placeholder="请输入产品名称"
                    class="layui-input" autocomplete="off">
            </div>
        </div>

        <!-- 分类 -->
        <div class="layui-form-item">
            <label class="layui-form-label">分类</label>
            <div class="layui-input-block">
                <select id="category_id" name="category_id" lay-verify="required">
                    <option value="">选择分类</option>
                    {volist name="productCategory" id="category" key="id"}
                    <option value="{$id}">{$category}</option>
                    {/volist}
                </select>
            </div>
        </div>

        <!-- 封面图（单张） -->
        <div class="layui-form-item">
            <label class="layui-form-label">封面</label>
            <div class="layui-input-block cover-con">
                <button type="button" class="layui-btn" id="upload-cover">上传封面</button>
                <div id="cover-img-preview"></div>
                <input type="hidden" id="cover" name="cover">
            </div>
        </div>

        <!-- 产品图（支持多张） -->
        <div class="layui-form-item">
            <label class="layui-form-label">产品图</label>
            <div class="layui-input-block">
                <button type="button" class="layui-btn" id="upload-content-images">上传产品图</button>
                <div id="content-images-preview"></div>
                <input type="hidden" id="content_image" name="content_image">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">上传</label>
            <div class="layui-input-block">
                <button type="button" class="layui-btn file-upload">弹出框上传</button>
            </div>
        </div>

        <!-- 简介 -->
        <div class="layui-form-item">
            <label class="layui-form-label">简介</label>
            <div class="layui-input-block">
                <textarea id="summary" name="summary" lay-verify="required" placeholder="请输入简介" class="layui-textarea"></textarea>
            </div>
        </div>

        <!-- 价格 -->
        <div class="layui-form-item">
            <label class="layui-form-label">价格</label>
            <div class="layui-input-block">
                <input type="number" id="price" name="price" required lay-verify="required" placeholder="请输入价格"
                    class="layui-input" autocomplete="off">
            </div>
        </div>
        
        <!-- 百度爱采购链接 -->
        <div class="layui-form-item">
            <label class="layui-form-label">爱采购</label>
            <div class="layui-input-block">
                <input type="url" id="b2b_uri" name="b2b_uri" placeholder="请输入百度爱采购链接" class="layui-input" autocomplete="off">
            </div>
        </div>

        <!-- 内容 -->
        <div class="layui-form-item">
            <label class="layui-form-label">内容</label>
            <div class="layui-input-block editor-wrapper">
                <div id="content-toolbar-container" class="toobal-container"></div>
                <div id="content-editor-container" class="editor-container"></div>
            </div>
        </div>

        <!-- 参数 -->
        <div class="layui-form-item">
            <label class="layui-form-label">参数</label>
            <div class="layui-input-block editor-wrapper">
                <div id="parameter-toolbar-container" class="toobal-container"></div>
                <div id="parameter-editor-container" class="editor-container"></div>
            </div>
        </div>

        <!-- 提交按钮 -->
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button type="submit" class="layui-btn layui-btn-normal">提交</button>
            </div>
        </div>
    </form>
</div>

<!-- 文件上传 -->
{include file="components/fileupload" /}

<script>
    // 富文本编辑器初始化
    const uploadURL = "/{$baseConfig.adminRoutePrefix}/api/file/upload";
    const cEditor = initEditor(uploadURL, '#content-editor-container', '#content-toolbar-container');
    const pEditor = initEditor(uploadURL, '#parameter-editor-container', '#parameter-toolbar-container');

    // 文件上传
    var upload = layui.upload;

    // 更新 content_image 字段的值
    var ids = [];
    function updateContentImageField() {
        $('#content_image').val(ids.join(','));
    }

    // 封面图上传（单张）
    var uploadCover = upload.render({
        elem: '#upload-cover',
        url: '/{$baseConfig.adminRoutePrefix}/api/file/upload',
        before: function (obj) {
            // 这里不再需要 obj.preview 进行预览，直接上传即可
            layer.msg('上传中...', { icon: 16, time: 0 });
        },
        done: function (res) {
            if (res.data) {
                var imgWrapper = $('<div class="img-wrapper" style="position: relative; display: inline-block; margin-right: 10px;">')
                    .append('<img src="' + res.data.url + '" alt="封面图" style="width: 90px; height: 90px;">')
                    .append('<button class="layui-btn layui-btn-xs layui-btn-danger delete-btn" style="position: absolute; top: 0; right: 0;">删除</button>')
                    .attr('data-id', res.data.id);

                $('#cover-img-preview').html(imgWrapper);
                $('#cover').val(res.data.id);

                // 删除
                imgWrapper.find('.delete-btn').on('click', function () {
                    $(this).parent().remove();
                    $('#cover').val('');
                });

                layer.closeAll();
            }
        },
        error: function () {
            layer.msg('上传失败，请重试');
            layer.closeAll();
        }
    });

    // 产品图上传（支持多张）
    var uploadContentImages = upload.render({
        elem: '#upload-content-images',
        url: '/{$baseConfig.adminRoutePrefix}/api/file/upload',
        multiple: true,
        before: function (obj) {
            // 上传前提示
            layer.msg('上传中...', { icon: 16, time: 0 });
        },
        done: function (res) {
            if (res.data) {
                // 使用接口返回的 url 展示产品图
                var imgWrapper = $('<div class="img-wrapper" style="position: relative; display: inline-block; margin-right: 10px;">')
                    .append('<img src="' + res.data.url + '" alt="产品图" style="width: 90px; height: 90px;">')
                    .append('<button class="layui-btn layui-btn-xs layui-btn-danger delete-btn" style="position: absolute; top: 0; right: 0;">删除</button>')
                    .attr('data-id', res.data.id);

                $('#content-images-preview').append(imgWrapper);

                // 删除
                imgWrapper.find('.delete-btn').on('click', function () {
                    var imgId = $(this).parent().attr('data-id');
                    imgId = String(imgId).trim();

                    ids = ids.filter(function (id) {
                        return String(id).trim() !== imgId; 
                    });

                    $(this).parent().remove();
                    $('#cover').val('');
                });

                // 更新 content_image 字段
                ids.push(res.data.id);
                updateContentImageField(); 
                layer.closeAll();  // 关闭上传中的提示
            }
        },
        error: function () {
            layer.msg('上传失败，请重试');
            layer.closeAll();  // 关闭上传中的提示
        }
    });

    // 提交表单时获取并打印表单数据
    document.getElementById('product-form').addEventListener('submit', function (e) {
        e.preventDefault(); // 阻止表单提交

        // 获取表单数据
        const formData = new FormData(this);
        let formObject = {};

        formData.forEach((value, key) => {
            formObject[key] = value;
        });

        let content = cEditor.getHtml();
        let parameter = pEditor.getHtml();
        formObject.content = content;
        formObject.parameter = parameter;

        // 打印表单内容
        console.log('提交的表单数据:', formObject);

        // 如果需要，可以在这里通过 AJAX 提交表单数据
        // 例如: 
        // fetch('/submit', {
        //     method: 'POST',
        //     body: formData
        // })
        // .then(response => response.json())
        // .then(data => console.log(data))
    });
</script>
{/block}